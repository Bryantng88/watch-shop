// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//-----------------------------------------------------------------------------------------
// ----------------------------------------- Enum -----------------------------------------
enum Category {
  ENTRY
  MID_RANGE
  LUXURY
}

enum UserRole {
  ADMIN
  STAFF
  CUSTOMER
}

enum ProductType {
  WATCH_STRAP
  BOX
  ACCESSORIES
  SERVICE
  PARTS
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
}

enum ServiceRequestStatus {
  PENDING // t·∫°o m·ªõi, ch·ªù ki·ªÉm tra
  DIAGNOSING // ƒëang ch·∫©n ƒëo√°n
  WAIT_APPROVAL // ch·ªù kh√°ch duy·ªát b√°o gi√°
  IN_PROGRESS // ƒëang s·ª≠a
  COMPLETED // ho√†n t·∫•t k·ªπ thu·∫≠t
  DELIVERED // giao/tr·∫£ xong
  CANCELED
}

enum ServicePriority {
  NORMAL
  HIGH
  URGENT
}

enum ServiceDetail {
  BASIC
  OVERHAUL
  SPA
  PARTS_CHANGE
  BATTERY_CHANGE
}

enum ServiceType {
  WARRANTY
  PAID
}

enum ProductStatus {
  ACTIVE
  HOLD
  SOLD
  CONSIGNED
  HIDDEN
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum Gender {
  MEN
  WOMEN
  UNISEX
}

enum Glass {
  SAPPHIRE
  ACRYLIC
  MINERAL
  HARDLEX
  AR_COATED
}

enum ImageRole {
  PRIMARY
  GALLERY
  THUMB
}

enum BrandStatus {
  ACTIVE
  INACTIVE
  HIDDEN
}

enum CaseType {
  ROUND
  TANK
  SQUARE
  SPECIAL
  OTHER
  TONNEAU
  CUSHION
  OVAL
  ASYMMETRICAL
  OCTAGON
  POLYGON
}

enum Strap {
  LEATHER
  BRACELET
  RUBBER
  NATO
  CANVAS
  SPECIAL
}

enum VendorRole {
  SUPPLIER // ngu·ªìn mua/nh·∫≠p h√†ng
  SERVICE // trung t√¢m b·∫£o h√†nh/s·ª≠a ch·ªØa
  BOTH
  PRIVATE_SELLER // ng∆∞·ªùi b√°n c√° nh√¢n
}

enum PaymentMethod {
  COD
  MOMO
  CREDIT_CARD
  BANK_TRANSFER
  PAYPAL
  CASH
}

enum InvoiceType {
  SALE // b√°n cho customer, th∆∞·ªùng map t·ª´ Order
  PURCHASE // mua t·ª´ vendor (nh·∫≠p h√†ng/buy-back)
  SERVICE // thu ph√≠ d·ªãch v·ª•
  ADJUSTMENT // ƒëi·ªÅu ch·ªânh, ghi n·ª£/ghi c√≥
  REFUND // ho√†n ti·ªÅn
}

enum InvoiceStatus {
  DRAFT
  ISSUED // ƒë√£ ph√°t h√†nh/s·ªë h√≥a ƒë∆°n
  PARTIALLY_PAID
  PAID
  VOID
  CANCELLED
}

enum MovementType {
  AUTOMATIC
  HAND_WOUND
  QUARTZ
  SOLAR
  KINETIC
  MECHAQUARTZ
  SPRING_DRIVE
  HYBRID
}

enum CaseMaterial {
  STAINLESS_STEEL
  TITANIUM
  CERAMIC
  CARBON
  GOLD
  PLATINUM
  SILVER
  BRASS
  TWO_TONE
  OTHER
}

enum PartType {
  GLASS
  RUBBER_GASKET
  SRAP
  BUCKLE
  SPRING_BAR
  BATTERY
  MOVEMENT_PART
  OTHER
  BEZEL
  INSERT
}

enum GoldColor {
  YELLOW
  WHITE
  ROSE
}

enum LengthLabel {
  L16
  L17
  L18
  L19
  L20
}

enum VendorType {
  IN_HOUSE // k·ªπ thu·∫≠t n·ªôi b·ªô
  PARTNER // ƒë·ªëi t√°c s·ª≠a ch·ªØa
  AUTHORIZED // TTBH ch√≠nh h√£ng
  OTHER
}

enum AcquisitionType {
  PURCHASE // mua t·ª´ vendor
  CONSIGNMENT // k√Ω g·ª≠i
  TRADE_IN // kh√°ch ƒë·ªïi ‚Äì b√π
  BUY_BACK // mua l·∫°i t·ª´ kh√°ch (kh√¥ng k√®m ƒë·ªïi)
}

//---------------------------------------------------------------------------------------------
// ----------------------------------------- Metadata -----------------------------------------
model MarketSegment {
  id         String      @id @default(cuid())
  name       String      @unique
  watchSpecs WatchSpec[]
}

model Complication {
  id         String      @id @default(cuid())
  name       String      @unique
  watchSpecs WatchSpec[]
}

model Brand {
  id           String      @id @default(cuid())
  name         String
  slug         String      @unique // d√πng cho URL
  country      String? // "Japan", "Switzerland"...
  foundedYear  Int?
  website      String?
  logoUrl      String?
  isAuthorized Boolean     @default(false) // b·∫°n l√† ƒë·∫°i l√Ω ·ªßy quy·ªÅn?
  status       BrandStatus @default(ACTIVE)
  description  String?

  // optional: cho SEO / s·∫Øp x·∫øp
  sortOrder Int @default(0)

  products  Product[]
  WatchSpec WatchSpec[]

  @@unique([name]) // ch·ªëng tr√πng
  @@index([country])
  @@index([status, sortOrder])
}

model ProductImage {
  id        String  @id @default(cuid())
  product   Product @relation(fields: [productId], references: [id])
  productId String

  // Kh√≥a trong bucket (kh√¥ng g·ªìm domain)
  fileKey String // vd: "products/ck98.../a2f3-...-main.jpg"

  // Metadata h·ªØu √≠ch
  role        ImageRole @default(GALLERY)
  alt         String?
  width       Int?
  height      Int?
  mime        String?
  sizeBytes   Int?
  sortOrder   Int       @default(0)
  dominantHex String? // d√πng l√†m blur/placeholder

  // B·∫•t bi·∫øn & ki·ªÉm so√°t cache
  contentHash String? // d√πng ƒë·ªÉ ki·ªÉm tra tr√πng/ƒë·ªïi t√™n theo hash

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//-------------------------------------------------------------------------------------------
// ----------------------------------------- Orders -----------------------------------------
model Order {
  id         String    @id @default(cuid())
  orderCode  String    @unique // v√≠ d·ª• "ORD-123456"
  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId String?

  // --- Snapshot th√¥ng tin giao h√†ng l√∫c ƒë·∫∑t (kh√¥ng ph·ª• thu·ªôc Customer) ---
  shipName      String
  shipPhone     String
  shipEmail     String
  shipAddress   String
  shipWard      String?
  shipCity      String
  // --- Ti·ªÅn t·ªá ---
  subtotal      Decimal        @db.Decimal(12, 2)
  shippingFee   Decimal?       @db.Decimal(12, 2)
  total         Decimal        @db.Decimal(12, 2)
  status        OrderStatus    @default(PENDING)
  paymentStatus PaymentStatus  @default(UNPAID)
  paymentMethod PaymentMethod? // n·∫øu bi·∫øt ƒë∆∞·ª£c
  items         OrderItem[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  Invoice       Invoice[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id              String            @id @default(cuid())
  order           Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId         String
  // --- Snapshot s·∫£n ph·∫©m t·∫°i th·ªùi ƒëi·ªÉm ƒë·∫∑t ---
  productId       String? // n·∫øu b·∫°n c√≥ b·∫£ng products ri√™ng
  title           String
  price           Decimal           @db.Decimal(12, 2)
  quantity        Int
  subtotal        Decimal           @db.Decimal(12, 2)
  img             String? // ·∫£nh minh ho·∫° l√∫c ƒë·∫∑t (tu·ª≥ ch·ªçn)
  createdAt       DateTime          @default(now())
  Product         Product?          @relation(fields: [productId], references: [id])
  ServiceRequest  ServiceRequest[]
  AcquisitionItem AcquisitionItem[]

  @@index([orderId])
  @@index([productId])
}

//---------------------------------------------------------------------------------------------
// ----------------------------------------- Inventory -----------------------------------------
model Product {
  id                 String              @id @default(cuid())
  slug               String              @unique // d√πng cho URL
  title              String
  image              ProductImage[]
  status             ProductStatus       @default(ACTIVE)
  primaryImageUrl    String?
  type               ProductType
  orderItems         OrderItem[]
  brandId            String?
  brand              Brand?              @relation(fields: [brandId], references: [id], onDelete: SetNull)
  seoTitle           String?
  seoDescription     String?
  isStockManaged     Boolean             @default(true)
  maxQtyPerOrder     Int                 @default(99)
  publishedAt        DateTime?
  variants           ProductVariant[]
  watchSpec          WatchSpec?
  vendor             Vendor?             @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId           String?
  maintenanceRecords MaintenanceRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // n·∫øu c√≥ OrderItem tr·ªè v·ªÅ, b·∫°n v·∫´n s·ª≠a product b√¨nh th∆∞·ªùng;
  // snapshot tr√™n OrderItem gi√∫p h√≥a ƒë∆°n kh√¥ng ƒë·ªïi.

  ServiceRequest  ServiceRequest[]
  AcquisitionItem AcquisitionItem[]
  InvoiceItem     InvoiceItem[]

  @@index([status])
  @@index([brandId])
  @@index([type])
  @@index([status, type, publishedAt])
  @@index([createdAt])
  @@index([updatedAt])
}

model ProductVariant {
  id                String              @id @default(cuid())
  product           Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId         String
  sku               String?             @unique
  name              String? // v√≠ d·ª•: "ƒêen 20mm"
  price             Decimal?            @db.Decimal(12, 2) // override gi√° n·∫øu kh√°c product.price
  strapSpec         StrapVariantSpec?
  partSpec          PartVariantSpec?
  stockQty          Int                 @default(0)
  isStockManaged    Boolean?            @default(true)
  isActive          Boolean             @default(true)
  maxQtyPerOrder    Int                 @default(99) // kh√°c product-level n·∫øu c·∫ßn
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  ServiceRequest    ServiceRequest[]
  MaintenanceRecord MaintenanceRecord[]
  MaintenancePart   MaintenancePart[]
  AcquisitionItem   AcquisitionItem[]
  InvoiceItem       InvoiceItem[]

  @@index([productId])
  @@index([isActive])
}

model PartVariantSpec {
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId String         @id
  partType  PartType
}

model WatchSpec {
  product         Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String          @id
  brandId         String?
  brand           Brand?          @relation(fields: [brandId], references: [id], onDelete: SetNull)
  model           String?
  year            String?
  caseType        CaseType        @default(ROUND)
  marketSegment   MarketSegment[]
  complication    Complication[]
  category        Category[]
  gender          Gender          @default(MEN)
  length          Decimal         @db.Decimal(12, 2)
  width           Decimal         @db.Decimal(12, 2)
  thickness       Decimal         @db.Decimal(12, 2)
  movement        MovementType    @default(AUTOMATIC)
  caliber         String?
  caseMaterial    CaseMaterial    @default(STAINLESS_STEEL)
  goldKarat       Int? // ch·ªâ d√πng khi caseMaterial = GOLD
  goldColor       GoldColor? // ch·ªâ d√πng khi caseMaterial = GOLD
  caseSize        String?
  dialColor       String?
  marketSegmentId String?
  strap           Strap           @default(LEATHER)
  glass           Glass           @default(MINERAL)
  boxIncluded     Boolean         @default(false)
  bookletIncluded Boolean         @default(false)
  cardIncluded    Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model StrapVariantSpec {
  // 1‚Äì1 v·ªõi ProductVariant (variant-level)
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId String         @id

  widthMM      Int
  lengthLabel  LengthLabel?
  color        String?
  material     Strap        @default(LEATHER)
  quickRelease Boolean?     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([widthMM])
  @@index([material])
  @@index([lengthLabel])
}

// -------------------------------------------------------------------------------------------
// ----------------------------------------- Service -----------------------------------------

model ServiceCatalog {
  id           String   @id @default(cuid())
  code         String   @unique // v√≠ d·ª•: POLISH, OVERHAUL
  name         String
  description  String?
  defaultPrice Decimal? @db.Decimal(12, 2)
  durationMin  Int? // ∆∞·ªõc l∆∞·ª£ng ph√∫t/gi·ªù

  isActive            Boolean            @default(true)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  MaintenanceRecord   MaintenanceRecord? @relation(fields: [maintenanceRecordId], references: [id])
  maintenanceRecordId String?
}

model ServiceRequest {
  id          String      @id @default(cuid())
  type        ServiceType @default(PAID) // üëà ph√¢n bi·ªát ngay t·ª´ ƒë·∫ßu
  billable    Boolean     @default(true) // PAID=true, WARRANTY=false
  orderItem   OrderItem?  @relation(fields: [orderItemId], references: [id], onDelete: SetNull)
  orderItemId String?

  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerId String?

  // ƒë·ªìng h·ªì c·∫ßn b·∫£o tr√¨:
  product   Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  // N·∫øu l√† h√†ng ngo√†i catalog ‚Üí snapshot nh·∫≠n di·ªán
  brandSnapshot  String?
  modelSnapshot  String?
  refSnapshot    String?
  serialSnapshot String?

  appointmentAt  DateTime?
  status         ServiceRequestStatus @default(PENDING)
  notes          String?
  warrantyUntil  DateTime? // m·ªëc b·∫£o h√†nh c√≤n hi·ªáu l·ª±c
  warrantyPolicy String? // m√¥ t·∫£/policy √°p d·ª•ng (n·∫øu c√≥)

  maintenance MaintenanceRecord[]
  // ...
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  Invoice     Invoice[]

  @@index([customerId])
  @@index([productId])
  @@index([variantId])
  @@index([orderItemId])
  @@index([status])
}

model MaintenanceRecord {
  id       String      @id @default(cuid())
  type     ServiceType @default(PAID)
  billable Boolean     @default(true)

  // Quan h·ªá ng∆∞·ª£c v·ªÅ request (n·∫øu t·∫°o t·ª´ request)
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id], onDelete: SetNull)
  serviceRequestId String?

  // ƒê·ªìng h·ªì m·ª•c ti√™u (trong catalog)
  product   Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  // Snapshot nh·∫≠n di·ªán (n·∫øu kh√¥ng g·∫Øn catalog)
  brandSnapshot  String?
  modelSnapshot  String?
  refSnapshot    String?
  serialSnapshot String?

  // d√πng chung Vendor
  vendor   Vendor? @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId String?

  // snapshot ƒë·ªÉ an to√†n l·ªãch s·ª≠
  servicedByName String?
  vendorName     String?

  // Parts d√πng trong service (tr·ª´ t·ªìn khi c√≥ variantId)
  parts         MaintenancePart[]
  serviceDetail ServiceCatalog[]
  // M·ªëc th·ªùi gian
  servicedAt    DateTime?
  notes         String?

  totalCost     Decimal? @db.Decimal(12, 2) // labor + parts + outsource + shipping + tax
  // n·∫øu l√† d·ªãch v·ª• thu ph√≠ kh√°ch:
  billed        Boolean  @default(false)
  invoiceId     String? // link t·ªõi Invoice n·∫øu c√≥
  revenueAmount Decimal? @db.Decimal(12, 2) // s·ªë ti·ªÅn thu kh√°ch cho service (n·∫øu c√≥)

  currency String @default("VND")

  @@index([serviceRequestId])
  @@index([productId])
  @@index([variantId])
  @@index([vendorId])
}

model MaintenancePart {
  id       String            @id @default(cuid())
  record   MaintenanceRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  recordId String

  // n·∫øu l·∫•y t·ª´ kho: link t·ªõi variant linh ki·ªán
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  name     String // n·∫øu kh√¥ng link variant th√¨ snapshot t√™n
  quantity Int      @default(1)
  unitCost Decimal? @db.Decimal(12, 2)
  notes    String?
}

//-------------------------------------------------------------------------------------------
// ----------------------------------------- Acquisition ------------------------------------
model Vendor {
  id           String              @id @default(cuid())
  name         String
  role         VendorRole          @default(SUPPLIER)
  isAuthorized Boolean             @default(false) // ƒë·∫°i l√Ω/TTBH ch√≠nh h√£ng?
  email        String?
  phone        String?
  address      String?
  note         String?
  // Li√™n k·∫øt 2 chi·ªÅu
  acquisitions Acquisition[] // ngu·ªìn nh·∫≠p
  services     MaintenanceRecord[] // d·ªãch v·ª• b·∫£o tr√¨ (n·∫øu h·ªç l√†m)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Product   Product[]
  Invoice   Invoice[]

  @@unique([name, role]) // tu·ª≥ b·∫°n, ƒë·ªÉ tr√°nh tr√πng
  @@index([role])
}

model Acquisition {
  id String @id @default(cuid())

  // Ngu·ªìn: ho·∫∑c vendor ho·∫∑c customer
  vendor     Vendor?   @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId   String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerId String?

  type       AcquisitionType @default(PURCHASE)
  acquiredAt DateTime

  // ti·ªÅn & gi·∫•y t·ªù
  cost          Decimal?  @db.Decimal(12, 2) // s·ªë ti·ªÅn b·∫°n chi ra
  currency      String? // "VND"
  payoutStatus  String? // PENDING/PAID (n·∫øu tr·∫£ cho kh√°ch)
  refNo         String? // m√£ ch·ª©ng t·ª´
  notes         String?
  condition     String? // t√¨nh tr·∫°ng (VG, Good‚Ä¶)
  warrantyUntil DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  AcquisitionItem AcquisitionItem[]
  Invoice         Invoice[]

  @@index([vendorId, acquiredAt])
  @@index([customerId, acquiredAt])
}

model AcquisitionItem {
  id            String      @id @default(cuid())
  acquisition   Acquisition @relation(fields: [acquisitionId], references: [id], onDelete: Cascade)
  acquisitionId String

  // Nh·∫≠p cho s·∫£n ph·∫©m/bi·∫øn th·ªÉ n√†o (khuy·∫øn ngh·ªã d√πng variantId)
  product   Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  quantity Int      @default(1) // ƒê·ªìng h·ªì = 1, d√¢y/ph·ª• ki·ªán = N
  unitCost Decimal? @db.Decimal(12, 2)
  currency String? // "VND"
  notes    String?

  // N·∫øu l√† buy-back chi·∫øc ƒë√£ b√°n tr∆∞·ªõc ƒë√≥
  sourceOrderItem   OrderItem? @relation(fields: [sourceOrderItemId], references: [id], onDelete: SetNull)
  sourceOrderItemId String?

  createdAt DateTime @default(now())

  @@index([acquisitionId])
  @@index([variantId])
}

//-------------------------------------------------------------------------------------------
// ----------------------------------------- Account ----------------------------------------
model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String? // null n·∫øu ƒëƒÉng nh·∫≠p b·∫±ng OAuth
  name         String?
  avatarUrl    String?

  // Li√™n k·∫øt 1‚Äì1 (t√πy ch·ªçn) sang Customer
  customer Customer?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  roleId    String?
  roles     Role[]   @relation("UserRoles")

  @@index([isActive])
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique // v√≠ d·ª•: "ADMIN", "SALES", "CS"
  description String?
  permissions Permission[] @relation("RolePermissions")
  users       User[]       @relation("UserRoles")
}

model Permission {
  id          String  @id @default(cuid())
  code        String  @unique // v√≠ d·ª•: "PRODUCT_READ", "ORDER_UPDATE"
  description String?
  roles       Role[]  @relation("RolePermissions")
}

model Customer {
  id     String  @id @default(cuid())
  name   String
  email  String? @unique
  phone  String? @db.VarChar(32)
  ward   String?
  city   String?
  // N·∫øu customer ƒë∆∞·ª£c t·∫°o t·ª´ t√†i kho·∫£n ƒëƒÉng nh·∫≠p
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String? @unique // ƒë·∫£m b·∫£o 1‚Äì1

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  orders         Order[]
  ServiceRequest ServiceRequest[]
  Acquisition    Acquisition[]
  Invoice        Invoice[]

  @@index([phone])
}

//-------------------------------------------------------------------------------------------
// ----------------------------------------- Invoice ----------------------------------------

model Invoice {
  id     String        @id @default(cuid())
  code   String?       @unique // s·ªë h√≥a ƒë∆°n (n·∫øu c·∫ßn)
  type   InvoiceType
  status InvoiceStatus @default(DRAFT)

  // Li√™n h·ªá: ho·∫∑c customer ho·∫∑c vendor
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerId String?
  vendor     Vendor?   @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  vendorId   String?

  // Li√™n k·∫øt nghi·ªáp v·ª• g·ªëc (tu·ª≥ tr∆∞·ªùng h·ª£p)
  order            Order?          @relation(fields: [orderId], references: [id], onDelete: SetNull)
  orderId          String?
  acquisition      Acquisition?    @relation(fields: [acquisitionId], references: [id], onDelete: SetNull)
  acquisitionId    String?
  serviceReq       ServiceRequest? @relation(fields: [serviceRequestId], references: [id], onDelete: SetNull)
  serviceRequestId String?

  // Ti·ªÅn t·ªá
  currency      String // "VND","USD"...
  subTotal      Decimal @db.Decimal(12, 2)
  taxTotal      Decimal @default(0) @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  grandTotal    Decimal @db.Decimal(12, 2)

  // Thanh to√°n & h·∫°n
  issuedAt DateTime? // ng√†y ph√°t h√†nh
  dueAt    DateTime? // h·∫°n thanh to√°n
  notes    String?

  // D√≤ng h√†ng
  items    InvoiceItem[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, status])
  @@index([customerId])
  @@index([vendorId])
  @@index([issuedAt])
  @@index([orderId])
  @@index([acquisitionId])
  @@index([serviceRequestId])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String

  // C√≥ th·ªÉ link t·ªõi Product/Variant ƒë·ªÉ tra c·ª©u
  product   Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  // Snapshot m√¥ t·∫£
  title       String // t√™n d√≤ng h√†ng (v√≠ d·ª• ‚ÄúRolex Submariner 114060‚Äù / ‚ÄúD·ªãch v·ª• Overhaul‚Äù)
  description String? // ghi ch√∫

  // Gi√° tr·ªã
  quantity  Decimal @default(1) @db.Decimal(12, 2) // v·ªõi ƒë·ªìng h·ªì th√¨ 1; d√¢y c√≥ th·ªÉ >1
  unitPrice Decimal @db.Decimal(12, 2)
  discount  Decimal @default(0) @db.Decimal(12, 2)
  taxRate   Decimal @default(0) @db.Decimal(5, 2) // % n·∫øu b·∫°n mu·ªën
  lineTotal Decimal @db.Decimal(12, 2) // sau discount + tax (tu·ª≥ c√°ch t√≠nh)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@index([variantId])
}

model Payment {
  id        String  @id @default(cuid())
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String

  method    PaymentMethod
  amount    Decimal       @db.Decimal(12, 2)
  currency  String
  paidAt    DateTime      @default(now())
  reference String? // s·ªë b√∫t to√°n/transaction id
  note      String?

  createdAt DateTime @default(now())

  @@index([invoiceId, paidAt])
}
